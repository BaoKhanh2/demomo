<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Table | Simple Admin</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" type="text/css" href="vendors/bootstrap/css/bootstrap-4.3.1/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="assets/css/simple-custom.css">
	<link rel="stylesheet" type="text/css" href="vendors/icon/mdi/css/materialdesignicons.min.css">
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<div class="col-md-2 sidebar">
					<div class="brand">
						<a href="#" class="brand-name">Simple Admin</a>
					</div>
					<div class="sidebar-sticky">
						<ul class="nav flex-column">
							<li class="nav-item">
								<a href="dashboard.html" class="nav-link"><i class="mdi mdi-monitor"></i> Dashboard</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample"><i class="mdi mdi-shape-outline"></i> UI Components <span class="badge badge-info">New</span><i class="mdi mdi-chevron-down float-right pr-2"></i></a>
								<div class="collapse" id="collapseExample">
									<a class="nav-link" href="button.html"><i class="mdi mdi-circle-medium"></i> Buttons</a>
									<a class="nav-link" href="chart.html"><i class="mdi mdi-circle-medium"></i> Chart</a>
									<a class="nav-link" href="input.html"><i class="mdi mdi-circle-medium"></i> Input</a>
									<a class="nav-link" href="modal.html"><i class="mdi mdi-circle-medium"></i> Modal</a>
									<a class="nav-link" href="widget.html"><i class="mdi mdi-circle-medium"></i> Widget</a>
								</div>
							</li>
							<li class="nav-item">
								<a href="form.html" class="nav-link"><i class="mdi mdi-lead-pencil"></i> Form</a>
							</li>
							<li class="nav-item">
								<a href="table.html" class="nav-link active"><i class="mdi mdi-table"></i> Data Table <button class="btn btn-dark-base btn-rounded float-right btn-sm"><i class="mdi mdi-plus"></i></button></a>
							</li>
						</ul>
					</div>
					<div class="nav-bottom">
						<ul class="nav">
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-account"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-message"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-bell"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-power"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
			<main class="col-md-9 col-lg-10" role="main">
				<div class="container">
					<div class="content-header mt-2 mb-3">
						<h2 class="text-header">Data Table</h2>
					</div>
					<div class="row basic">
						<div class="col-md-12 mb-3">
							<div class="card">
								<div class="card-body pb-0">
									<label class="title-body">Basic Table</label>
									<div class="table-responsive">
										<input type="text" id="search-input" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m..." />
										<button onclick="loadUsers()">T√¨m ki·∫øm</button>

										<table class="table">
											<thead>
												<tr>
													<th>H·ªç t√™n</th>
													<th>S·ªë ƒëi·ªán tho·∫°i</th>
													<th>Tr·∫°ng th√°i</th>
													<th>ƒê·ªãa ch·ªâ</th>
													<th>·∫¢nh ƒë·∫°i di·ªán</th>
													<th>Gi·ªõi t√≠nh</th>
													<th>Ng√†y sinh</th>
													<th>Thao t√°c</th>
												</tr>
											</thead>
											<tbody id="user-table-body"></tbody>
										</table>
								 $0
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Edit Modal -->
				<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="editUserModalLabel">Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="editUserForm">
									<input type="hidden" id="edit-user-id">
									<div class="form-group">
										<label for="edit-fullName">H·ªç t√™n</label>
										<input type="text" class="form-control" id="edit-fullName" required>
									</div>
									<div class="form-group">
										<label for="edit-phoneNumber">S·ªë ƒëi·ªán tho·∫°i</label>
										<input type="text" class="form-control" id="edit-phoneNumber" required>
									</div>
									<div class="form-group">
										<label for="edit-status">Tr·∫°ng th√°i</label>
										<select class="form-control" id="edit-status" required>
											<option value="Active">Active</option>
											<option value="Inactive">Inactive</option>
										</select>
									</div>
									<div class="form-group">
										<label for="edit-address">ƒê·ªãa ch·ªâ</label>
										<input type="text" class="form-control" id="edit-address" required>
									</div>
									<div class="form-group">
										<label for="edit-avatarUrl">·∫¢nh ƒë·∫°i di·ªán (URL)</label>
										<input type="text" class="form-control" id="edit-avatarUrl">
									</div>
									<div class="form-group">
										<label for="edit-gender">Gi·ªõi t√≠nh</label>
										<select class="form-control" id="edit-gender" required>
											<option value="Male">Nam</option>
											<option value="Female">N·ªØ</option>
											<option value="Other">Kh√°c</option>
										</select>
									</div>
									<div class="form-group">
										<label for="edit-dateOfBirth">Ng√†y sinh</label>
										<input type="date" class="form-control" id="edit-dateOfBirth" required>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
								<button type="button" class="btn btn-primary" onclick="saveUser()">L∆∞u</button>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Jquery -->
	<script src="vendors/bootstrap/js/jquery-3.3.1/jquery-3.3.1.min.js"></script>
	<!-- Popper -->
	<script src="vendors/bootstrap/js/popper/popper.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="vendors/bootstrap/js/bootstrap-4.3.1/bootstrap.min.js"></script>
	<script>
async function loadUsers() {
	const searchValue = document.getElementById("search-input")?.value || "";

	try {
		// Th·ª≠ nhi·ªÅu API endpoints v·ªõi CORS header
		const apiUrls = [
			`http://localhost:8070/users/search?keyword=name&value=${searchValue}`,
			`http://localhost:8000/user/users/search?keyword=name&value=${searchValue}`,
			`http://localhost:8080/users/search?keyword=name&value=${searchValue}`,
			`http://localhost:8070/users`,
			`http://localhost:8000/user/users`
		];
		
		let users = [];
		let loadedFrom = '';
		
		for (const apiUrl of apiUrls) {
			try {
				console.log(`üîó Trying API: ${apiUrl}`);
				const res = await fetch(apiUrl, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
						'Access-Control-Allow-Origin': '*'
					}
				});
				
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				
				const data = await res.json();
				console.log("‚úÖ API response:", data);
				
				// Parse response data linh ho·∫°t
				if (data.result && Array.isArray(data.result)) {
					users = data.result;
				} else if (data.data && Array.isArray(data.data)) {
					users = data.data;
				} else if (Array.isArray(data)) {
					users = data;
				}
				
				if (users.length > 0) {
					loadedFrom = apiUrl;
					break;
				}
			} catch (error) {
				console.warn(`‚ö†Ô∏è Failed to load from ${apiUrl}: ${error.message}`);
			}
		}
		
		console.log(`‚úÖ Loaded ${users.length} users from: ${loadedFrom}`);
		
		// Filter users n·∫øu c√≥ search value
		if (searchValue && users.length > 0) {
			users = users.filter(user => 
				user.fullName?.toLowerCase().includes(searchValue.toLowerCase()) ||
				user.phoneNumber?.includes(searchValue)
			);
		}
		
		// Render table
		const tbody = document.getElementById("user-table-body");
		tbody.innerHTML = "";
		
		if (users.length === 0) {
			tbody.innerHTML = `<tr><td colspan="8" class="text-center">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</td></tr>`;
			return;
		}

		users.forEach(user => {
			const avatarImg = user.avatarUrl ? 
				`<img src="${user.avatarUrl}" width="40" height="40" alt="Avatar" onerror="this.src='../client/public/images/cart_logo.png'" />` : 
				'Kh√¥ng c√≥ ·∫£nh';
				
			const row = `<tr>
				<td>${user.fullName || 'N/A'}</td>
				<td>${user.phoneNumber || 'N/A'}</td>
				<td>${user.status || 'N/A'}</td>
				<td>${user.address || 'N/A'}</td>
				<td>${avatarImg}</td>
				<td>${user.gender || 'N/A'}</td>
				<td>${user.dateOfBirth || 'N/A'}</td>
				<td>
					<button class="btn btn-warning btn-sm" onclick='editUser(${JSON.stringify(user).replace(/'/g, "&#39;")})'><i class="mdi mdi-pencil"></i> S·ª≠a</button>
					<button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')"><i class="mdi mdi-delete"></i> X√≥a</button>
				</td>
			</tr>`;
			tbody.innerHTML += row;
		});
	} catch (err) {
		console.error("‚ùå L·ªói khi g·ªçi API:", err);
		alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng. Ki·ªÉm tra l·∫°i backend ho·∫∑c m·∫°ng.");
	}
}

function editUser(user) {
	document.getElementById("edit-user-id").value = user.id;
	document.getElementById("edit-fullName").value = user.fullName;
	document.getElementById("edit-phoneNumber").value = user.phoneNumber;
	document.getElementById("edit-status").value = user.status;
	document.getElementById("edit-address").value = user.address;
	document.getElementById("edit-avatarUrl").value = user.avatarUrl;
	document.getElementById("edit-gender").value = user.gender;
	document.getElementById("edit-dateOfBirth").value = user.dateOfBirth;

	$('#editUserModal').modal('show');
}

async function saveUser() {
	const userId = document.getElementById("edit-user-id").value;
	const updatedUser = {
		fullName: document.getElementById("edit-fullName").value,
		phoneNumber: document.getElementById("edit-phoneNumber").value,
		status: document.getElementById("edit-status").value,
		address: document.getElementById("edit-address").value,
		avatarUrl: document.getElementById("edit-avatarUrl").value,
		gender: document.getElementById("edit-gender").value,
		dateOfBirth: document.getElementById("edit-dateOfBirth").value
	};

	// Validate required fields
	if (!updatedUser.fullName || !updatedUser.phoneNumber) {
		alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
		return;
	}

	try {
		// Th·ª≠ nhi·ªÅu endpoints cho update user
		const updateUrls = [
			`http://localhost:8070/users/update/${userId}`,
			`http://localhost:8000/user/users/update/${userId}`,
			`http://localhost:8070/users/${userId}`
		];
		
		let updateSuccess = false;
		
		for (const updateUrl of updateUrls) {
			try {
				console.log(`üîÑ Trying update API: ${updateUrl}`);
				const res = await fetch(updateUrl, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Access-Control-Allow-Origin': '*'
					},
					body: JSON.stringify(updatedUser)
				});

				if (!res.ok) throw new Error(`HTTP ${res.status}`);

				const data = await res.json();
				console.log("‚úÖ User updated:", data);
				alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
				$('#editUserModal').modal('hide');
				loadUsers();
				updateSuccess = true;
				break;
			} catch (error) {
				console.warn(`‚ö†Ô∏è Failed to update via ${updateUrl}: ${error.message}`);
			}
		}
		
		if (!updateSuccess) {
			throw new Error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t qua t·∫•t c·∫£ c√°c API endpoints");
		}
		
	} catch (err) {
		console.error("‚ùå L·ªói c·∫≠p nh·∫≠t:", err);
		alert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: ${err.message}`);
	}
}

async function deleteUser(userId) {
	if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° ho·∫∑c c·∫•m ng∆∞·ªùi d√πng n√†y?")) return;

	try {
		// Th·ª≠ nhi·ªÅu endpoints cho delete/ban user
		const deleteUrls = [
			{ url: `http://localhost:8000/user/users/ban`, method: 'POST', body: { userId } },
			{ url: `http://localhost:8070/users/ban/${userId}`, method: 'POST', body: {} },
			{ url: `http://localhost:8070/users/${userId}`, method: 'DELETE', body: {} }
		];
		
		let deleteSuccess = false;
		
		for (const deleteConfig of deleteUrls) {
			try {
				console.log(`üóëÔ∏è Trying delete API: ${deleteConfig.url}`);
				const res = await fetch(deleteConfig.url, {
					method: deleteConfig.method,
					headers: {
						'Content-Type': 'application/json',
						'Access-Control-Allow-Origin': '*'
					},
					body: Object.keys(deleteConfig.body).length ? JSON.stringify(deleteConfig.body) : undefined
				});

				if (!res.ok) throw new Error(`HTTP ${res.status}`);

				const data = await res.json();
				console.log("‚úÖ User deleted/banned:", data);
				alert("ƒê√£ xo√°/c·∫•m ng∆∞·ªùi d√πng th√†nh c√¥ng!");
				loadUsers();
				deleteSuccess = true;
				break;
			} catch (error) {
				console.warn(`‚ö†Ô∏è Failed to delete via ${deleteConfig.url}: ${error.message}`);
			}
		}
		
		if (!deleteSuccess) {
			throw new Error("Kh√¥ng th·ªÉ x√≥a qua t·∫•t c·∫£ c√°c API endpoints");
		}
		
	} catch (err) {
		console.error("‚ùå L·ªói xo√°:", err);
		alert(`Kh√¥ng th·ªÉ xo√° ng∆∞·ªùi d√πng: ${err.message}`);
	}
}

// T·∫£i danh s√°ch khi trang load
window.onload = loadUsers;

	</script>
</body>
</html>