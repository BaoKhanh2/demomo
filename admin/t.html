<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Table | Simple Admin</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" type="text/css" href="vendors/bootstrap/css/bootstrap-4.3.1/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="assets/css/simple-custom.css">
	<link rel="stylesheet" type="text/css" href="vendors/icon/mdi/css/materialdesignicons.min.css">
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<div class="col-md-2 sidebar">
					<div class="brand">
						<a href="#" class="brand-name">Simple Admin</a>
					</div>
					<div class="sidebar-sticky">
						<ul class="nav flex-column">
							<li class="nav-item">
								<a href="dashboard.html" class="nav-link"><i class="mdi mdi-monitor"></i> Dashboard</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample"><i class="mdi mdi-shape-outline"></i> UI Components <span class="badge badge-info">New</span><i class="mdi mdi-chevron-down float-right pr-2"></i></a>
								<div class="collapse" id="collapseExample">
									<a class="nav-link" href="button.html"><i class="mdi mdi-circle-medium"></i> Buttons</a>
									<a class="nav-link" href="chart.html"><i class="mdi mdi-circle-medium"></i> Chart</a>
									<a class="nav-link" href="input.html"><i class="mdi mdi-circle-medium"></i> Input</a>
									<a class="nav-link" href="modal.html"><i class="mdi mdi-circle-medium"></i> Modal</a>
									<a class="nav-link" href="widget.html"><i class="mdi mdi-circle-medium"></i> Widget</a>
								</div>
							</li>
							<li class="nav-item">
								<a href="form.html" class="nav-link"><i class="mdi mdi-lead-pencil"></i> Form</a>
							</li>
							<li class="nav-item">
								<a href="table.html" class="nav-link active"><i class="mdi mdi-table"></i> Data Table <button class="btn btn-dark-base btn-rounded float-right btn-sm"><i class="mdi mdi-plus"></i></button></a>
							</li>
						</ul>
					</div>
					<div class="nav-bottom">
						<ul class="nav">
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-account"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-message"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-bell"></i></a></li>
							<li class="nav-item"><a href="#" class="nav-link"><i class="mdi mdi-power"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
			<main class="col-md-9 col-lg-10" role="main">
				<div class="container">
					<div class="content-header mt-2 mb-3">
						<h2 class="text-header">Data Table</h2>
					</div>
					<div class="row basic">
						<div class="col-md-12 mb-3">
							<div class="card">
								<div class="card-body pb-0">
									<label class="title-body">Basic Table</label>
									<div class="table-responsive">
										<input type="text" id="search-input" placeholder="Nhập tên để tìm..." />
										<button onclick="loadUsers()">Tìm kiếm</button>

										<table class="table">
											<thead>
												<tr>
													<th>Họ tên</th>
													<th>Số điện thoại</th>
													<th>Trạng thái</th>
													<th>Địa chỉ</th>
													<th>Ảnh đại diện</th>
													<th>Giới tính</th>
													<th>Ngày sinh</th>
													<th>Thao tác</th>
												</tr>
											</thead>
											<tbody id="user-table-body"></tbody>
										</table>
								 $0
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Edit Modal -->
				<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="editUserModalLabel">Chỉnh sửa người dùng</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form id="editUserForm">
									<input type="hidden" id="edit-user-id">
									<div class="form-group">
										<label for="edit-fullName">Họ tên</label>
										<input type="text" class="form-control" id="edit-fullName" required>
									</div>
									<div class="form-group">
										<label for="edit-phoneNumber">Số điện thoại</label>
										<input type="text" class="form-control" id="edit-phoneNumber" required>
									</div>
									<div class="form-group">
										<label for="edit-status">Trạng thái</label>
										<select class="form-control" id="edit-status" required>
											<option value="Active">Active</option>
											<option value="Inactive">Inactive</option>
										</select>
									</div>
									<div class="form-group">
										<label for="edit-address">Địa chỉ</label>
										<input type="text" class="form-control" id="edit-address" required>
									</div>
									<div class="form-group">
										<label for="edit-avatarUrl">Ảnh đại diện (URL)</label>
										<input type="text" class="form-control" id="edit-avatarUrl">
									</div>
									<div class="form-group">
										<label for="edit-gender">Giới tính</label>
										<select class="form-control" id="edit-gender" required>
											<option value="Male">Nam</option>
											<option value="Female">Nữ</option>
											<option value="Other">Khác</option>
										</select>
									</div>
									<div class="form-group">
										<label for="edit-dateOfBirth">Ngày sinh</label>
										<input type="date" class="form-control" id="edit-dateOfBirth" required>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
								<button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- Jquery -->
	<script src="vendors/bootstrap/js/jquery-3.3.1/jquery-3.3.1.min.js"></script>
	<!-- Popper -->
	<script src="vendors/bootstrap/js/popper/popper.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="vendors/bootstrap/js/bootstrap-4.3.1/bootstrap.min.js"></script>
	<script>
		async function loadUsers() {
			const keyword = 'name';
			const value = document.getElementById("search-input")?.value || "f";

			try {
				const res = await fetch(`http://localhost:8070/users/search?keyword=${keyword}&value=${value}`);
				if (!res.ok) {
					throw new Error(`HTTP error! Status: ${res.status}`);
				}

				const data = await res.json();
				console.log("✅ API response:", data);

				const users = Array.isArray(data.result) ? data.result : [];
				const tbody = document.getElementById("user-table-body");
				tbody.innerHTML = "";

				users.forEach(user => {
					const row = `<tr>
						<td>${user.fullName}</td>
						<td>${user.phoneNumber}</td>
						<td>${user.status}</td>
						<td>${user.address}</td>
						<td><img src="${user.avatarUrl}" width="40" height="40" alt="Avatar" /></td>
						<td>${user.gender}</td>
						<td>${user.dateOfBirth}</td>
						<td>
							<button class="btn btn-warning btn-sm" onclick='editUser(${JSON.stringify(user)})'><i class="mdi mdi-pencil"></i> Sửa</button>
							<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})"><i class="mdi mdi-delete"></i> Xóa</button>
						</td>
					</tr>`;
					tbody.innerHTML += row;
				});
			} catch (err) {
				console.error("❌ Lỗi khi gọi API:", err);
				alert("Không thể tải dữ liệu người dùng. Kiểm tra lại backend hoặc mạng.");
			}
		}

		function editUser(user) {
			// Populate the modal with user data
			document.getElementById("edit-user-id").value = user.id;
			document.getElementById("edit-fullName").value = user.fullName;
			document.getElementById("edit-phoneNumber").value = user.phoneNumber;
			document.getElementById("edit-status").value = user.status;
			document.getElementById("edit-address").value = user.address;
			document.getElementById("edit-avatarUrl").value = user.avatarUrl;
			document.getElementById("edit-gender").value = user.gender;
			document.getElementById("edit-dateOfBirth").value = user.dateOfBirth;

			// Show the modal
			$('#editUserModal').modal('show');
		}

		async function saveUser() {
			const userId = document.getElementById("edit-user-id").value;
			const updatedUser = {
				id: userId,
				fullName: document.getElementById("edit-fullName").value,
				phoneNumber: document.getElementById("edit-phoneNumber").value,
				status: document.getElementById("edit-status").value,
				address: document.getElementById("edit-address").value,
				avatarUrl: document.getElementById("edit-avatarUrl").value,
				gender: document.getElementById("edit-gender").value,
				dateOfBirth: document.getElementById("edit-dateOfBirth").value
			};

			try {
				const res = await fetch(`http://localhost:8070/users/${userId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(updatedUser)
				});

				if (!res.ok) {
					throw new Error(`HTTP error! Status: ${res.status}`);
				}

				const data = await res.json();
				console.log("✅ User updated:", data);
				alert("Cập nhật người dùng thành công!");
				$('#editUserModal').modal('hide');
				loadUsers(); // Refresh the table
			} catch (err) {
				console.error("❌ Lỗi khi cập nhật người dùng:", err);
				alert("Không thể cập nhật người dùng. Kiểm tra lại backend hoặc mạng.");
			}
		}

		async function deleteUser(userId) {
    if (!confirm("Bạn có chắc chắn muốn xóa hoặc cấm người dùng này?")) return;

    try {
        const res = await fetch(`http://localhost:8000/user/users/ban/${userId}`, {
            method: 'DELETE', // Adjust this if the endpoint uses a different method (e.g., POST or PUT)
            headers: {
                'Content-Type': 'application/json'
            }
            // If the endpoint requires a body, uncomment and adjust the following:
            // body: JSON.stringify({ id: userId })
        });

        if (!res.ok) {
            throw new Error(`HTTP error! Status: ${res.status}`);
        }

        const data = await res.json();
        console.log("✅ User banned/deleted:", data);
        alert("Xóa hoặc cấm người dùng thành công!");
        loadUsers(); // Refresh the table
    } catch (err) {
        console.error("❌ Lỗi khi xóa/cấm người dùng:", err);
        alert("Không thể xóa hoặc cấm người dùng. Kiểm tra lại backend hoặc mạng.");
    }
}

		// Load users when theGenderpage loads
		window.onload = loadUsers;
	</script>
</body>
</html>